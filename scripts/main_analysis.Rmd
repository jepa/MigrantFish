---
title: "Untitled"
author: "Juliano Palacios-Abrantes"
date: '2022-04-20'
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}

library(MyFunctions)

packages <- c(
  "readxl", # Read dataframe
  "data.table", # Read dataframe (Fast!)
  "wesanderson",
  "tidyverse", # for all data wrangling and ggplot
  "janitor", # for data cleaning
  "tidytext", # to order the facet wrap https://juliasilge.com/blog/reorder-within/
  "cowplot", # for figures 1 and 3
  # "ggimage", #for reading images to the circular plot
  "ggrepel", # for nice plot labels
  # "ggsflabel", # for nice sf_plots labels
  # "spdep", # for poly2nb old
  "sf", #Spatial analysis 
  "sp", #Spatial analysis 
  # "purrr",#Spatial analysis
  # "rgdal", #Spatial analysis
  "tools", #Spatial analysis 
  "parallel", # for parallelization
  # "taxize", # For getting species names
  # "rfishbase", # for species ecosystem affinity
  "zoo", #for runing mean
  # "pgirmess", # for dune test after kurtis wallas
  "rnaturalearth", # For maps
  "R.matlab", # For Gabs distributions
  "parallel"
)

my_lib(packages)

# Fix new updates of sf package
sf::sf_use_s2(use_s2 = FALSE)
```


# Methods

1.- Get transboundary species list

1.1- Remove highly migratory species based on literature

2- High seas shapefile

2.1- FAO Areas ID

3.- Identiy what transboundary species are actually straddling 

4.- Be happy, happy like a hippo

# Data

## Shapefiles 

```{r shapefiles, eval = F}

# World land maps
world_land <- ne_countries(scale = 'medium', returnclass = c("sf")) %>% 
  st_transform(crs = 4326)# 4326

# ggplot(world_land) +
#   geom_sf()

# FAO regions
fao_regions <- my_sf("FAO") %>% 
  filter(F_LEVEL == "MAJOR")
st_crs(fao_regions) = 4326
  
# fao_regions <- fao_regions %>%
  # st_set_crs(4326) #%>% 
  # st_transform(crs = "+proj=eck4")

# fao_regions %>% 
#   ggplot() +
#   geom_sf(aes(fill = F_AREA))


# First get Vicky's data to get high seas
EEZ_CellID <- my_path("Spa","DBEM", "EEZ_CellID.xlsx", read = TRUE)
colnames(EEZ_CellID) <- c("eez_id","index")

EEZ_CellID <- EEZ_CellID %>% 
  mutate(area_code = as.character(eez_id))

# Coordinatres DBEM
coords_dbem <- my_path("Spa","DBEM","Lon_Lat_DBEM.txt",read = T, header = F)


dbem_sf <-st_as_sf(coords_dbem,
                           coords = c("lon", "lat")
) %>% 
  st_set_crs(4326) #%>%
  # st_transform(crs = "+proj=eck4")
  
  st_crs(dbem_sf) = 4326

# Combine both sf
dbem_fao_sf <- st_join(dbem_sf,
             fao_regions, join = st_intersects)

# DBEM FAO Regions
fao_grid <- dbem_fao_sf %>% 
  filter(!is.na(F_CODE)) %>% 
  as.data.frame() %>% 
  select(index,fao_area_code=F_CODE,area_code=F_CODE,ocean=OCEAN,name = NAME_EN) %>% 
  # filter(cat == "abnj") %>% 
  mutate_all(as.character) %>% 
  rename(fao_area_name = name)

# write_csv(fao_grid, my_path("Spa", "DBEM","fao_to_dbem_grid.csv"))


eez_grid <- left_join(EEZ_CellID,EEZIDs_List) %>% 
  select(index,eez_id,area_code = eez_id,name) %>% 
  mutate(cat = "eez",
         eez_name = name)
  

sau_fao_grid <- eez_grid %>% 
  mutate_all(as.character) %>% 
    bind_rows(fao_grid)

sau_fao_grid %>%
  left_join(complete_lon_lat_dbem) %>%
  ggplot() +
  geom_tile(
    aes(
      x = lon,
      y = lat,
      fill = area_code
    )
  ) +
  theme(legend.position = "")


# EEZs
world_eez <- my_sf("SAU",simple = 1000,system = "jepa")

# Lon-lat DBEM

# First get Vicky's data to get high seas
EEZ_CellID <- my_path("Spa","DBEM", "EEZ_CellID.xlsx", read = TRUE)
colnames(EEZ_CellID) <- c("id","index")

# Now our gridcell
abny <- my_path("Spa","DBEM","Lon_Lat_DBEM.txt",read = T, header = F) %>% 
  bind_cols(my_path("Spa","DBEM","WArea.txt",read = T, header = F) %>% slice(-259201)) %>% 
  filter(!index %in% EEZ_CellID$index) %>% 
  mutate(cat = ifelse(v1>0, "abnj","land")) %>% 
  select(-v1)

# SAVE FOR COMPLETE DBEM
complete_lon_lat_dbem <- my_path("Spa","DBEM","Lon_Lat_DBEM.txt",read = T, header = F) %>% 
  left_join(abny) %>% 
  mutate(cat = ifelse(is.na(cat), "eez",cat),
         index = as.character(index))


# Save for fouture
write_csv(complete_lon_lat_dbem, my_path("Spa", "DBEM","complete_lon_lat_dbem.csv"))

  # ggplot(complete_lon_lat_dbem) +
  # geom_tile(
  #   aes(
  #     x = lon,
  #     y = lat,
  #     fill = cat
  #   )
  # )

# All maps test
# ggplot() +
#   geom_sf(data = fao_regions, aes()) +
#   geom_sf(data = world_land, aes()) +
#   geom_sf(data = world_eez, aes())
  

### Get MEO to DBEM

meow_regions <- my_sf("MEOW")
st_crs(meow_regions) = 4326

meow_dbem <- st_join(dbem_sf,
             meow_regions, join = st_intersects)

dbem_meow_df <- meow_dbem %>% 
  filter(!is.na(ECO_CODE)) %>% 
  as.data.frame() %>% 
  select(-geometry) %>% 
  clean_names()
  
write_csv(dbem_meow_df, my_path("Spa", "MEOW","meow_dbem_grid.csv"))

  
  # First get Vicky's data to get high seas
EEZ_SAU <- my_path("Spa","DBEM", "Updated_EEZList_17June2016.xlsx", read = TRUE, system = "jepa")
colnames(EEZ_SAU) <- c("sau_code","eez")

complete_sau <- EEZ_SAU %>% 
  left_join(EEZ_CellID)

#   
# coords %>% 
#   left_join(EEZ_CellID) %>% 
#     rename(sau_eez_id = EEZID) %>% 
#     gather("code_na","code",f_code:sau_eez_id) %>%
  

  # write_csv(Coord, my_path("Spa", "DBEM","complete_lon_lat_dbem.csv"))






```


## Determining straddling stocks

```{r GetSppDistFun, eval = F}

GetSppDist=function(Spp,Model,Coord){
  
  Distpath <- paste(Data_Path,"Data/Distribution/",sep="")
  INDEX = seq(1,259200,1)
  # INDEX <- Coordinates$INDEX
  
  # SAU Distributions
  if(Model == "SAU_D"){
    File_Name <- paste("SAU_Distribution/DIST_GOOD_SP_")
  }
  
  # SAU Catch
  if(Model == "SAU_C"){
    File_Name <- paste("SAU_data_per_species/CATCH_SP_")
  }
  
  # Occurence
  if(Model == "Occ"){
    File_Name <- paste("Occurence/OCCURENCE_JULIANO_")
  }
  
  # ENM Model
  if(Model == "ENM"){
    File_Name <- paste("ENM/ENM_JULIANO_")
  }
  
  # DBEM Data
  # if(Model == "DBEM"){
  #   Distpath <- "/Volumes/DATA/JULIANO_NEYMAR/PristineSeasData
  #   Final_Path <- "ENM"
  #   File_Name <- paste("ENM_JULIANO",Spp,".mat",sep="")
  # }
  
  if(Model == "All"){
    
    Models_List <- c(paste(Distpath,"SAU_Distribution/DIST_GOOD_SP_",Spp,".mat",sep =""),
                     paste(Distpath,"Occurence/OCCURENCE_JULIANO_",Spp,".mat",sep=""),
                     paste(Distpath,"ENM/ENM_JULIANO_",Spp,".mat",sep="")
    )
    
    # Jumps species not modeled. NOTE: We only need one as ENM, Occ and SAU Dis have all the same 939 spp
    if(file.exists(Models_List[1])){
      
      Load <- lapply(Models_List, FUN=R.matlab::readMat, na.strings=0)
      
      sppdist <- as.data.frame(bind_cols(Load)) %>% 
        mutate(
          INDEX = INDEX,
          TaxonKey = Spp
        )
      colnames(sppdist) <- c("SAU_D","Occ","ENM","INDEX","TaxonKey")
      
      #### Step for SAU catch data that has to be averaged
      File_Name <- paste("SAU_data_per_species/CATCH_SP_")
      SppPath <- paste(Distpath,File_Name,Spp,".mat",sep="")
      
      # For now we're using only the last 10 years average, basicaaly if the species has been fished in any of these years, its considered present
      SAU_C_data <- as.data.frame(R.matlab::readMat(SppPath)) %>% 
        select(CATCH.1:CATCH.65) %>% 
        mutate(INDEX = INDEX) %>% 
        gather("Year","Catch",CATCH.56:CATCH.65) %>% # Last 10 years of data
        group_by(INDEX) %>% 
        summarise(SAU_C = mean(Catch,na.rm=T))
      
      # Join both tables
      sppdist <- sppdist %>% 
        left_join(SAU_C_data,
                  by = "INDEX") %>% 
        select(TaxonKey,INDEX,everything()) %>% 
        left_join(CoorG,
                  by = "INDEX")
      
      # Fix coordinate system incompatibility between Gab and DBEM
      sppdist <- suppressWarnings(sppdist[order(sppdist$latitude, rev(sppdist$longitude),decreasing=TRUE), ] %>% 
                                    mutate(INDEX = seq(1,259200,1)) %>% 
                                    gather("Model","Value",3:6) %>%
                                    mutate(Value = ifelse(is.na(Value), 0, Value)) # Converting NA's to ceros
      )
      
      getSppDist = sppdist
      
    }
    
  }else{  
    
    # Merge paths
    SppPath <- paste(Distpath,File_Name,Spp,".mat",sep="")
    
    if(file.exists(SppPath) == TRUE){
      
      #Install (if needed) R.matlab package
      if(!require(R.matlab)){
        install.packages("R.matlab")
      }
      
      # Read Files
      
      sppdist <- as.data.frame(R.matlab::readMat(SppPath)) %>% 
        mutate(INDEX = INDEX,
               Species = Spp) %>% 
        left_join(Coord) 
      
      # Fix coordinate system incompatibility between Gab and DBEM
      sppdist <- sppdist[order(sppdist$latitude, rev(sppdist$longitude),decreasing=TRUE), ] %>% 
        mutate(INDEX = seq(1,259200,1))
      
      # Return 
      getSppDist=sppdist
      
    }else{
      print(paste("No info for this species",Spp, "in",Model))
    }
    
  }
}
```

```{r StraddIndexFun, eval = F}


StraddIndex <- function(Spp,Model = "All",Neighbours,Coord,Index_Code){
  
  # Get model data from spps
  SppDist <- GetSppDist(Spp,Model,Coord)
  
    # Result 1. Number of Countries that share the species
  
  #____________ ESTIMATING MODEL INDEX (TRESHOLD 1)_________ #
  Trans_Spp <- SppDist %>%
    filter(#INDEX %in% Neighbours$INDEX,# Filter data only located within EEZs
      Model != "SAU_C") %>% # Only using observational and modelled data
    mutate(Value = ifelse(Value > 0, 1,0)) %>%  
    filter(Value > 0) %>%
    group_by(TaxonKey,
             INDEX
    ) %>%
    summarise(Model_Index = sum(Value,na.rm=T)/3
    ) %>%
    filter(Model_Index > 0.4) %>% # at least 2 sources agree
    # ____________ ESTIMATING FUNDAMENTAL NICHE (TRESHOLD 2)_________ #
    left_join(SppDist,
              by = c("TaxonKey","INDEX")) %>%
    filter(Model == "SAU_C", # Only keeping cells where SAU catch exists
           Value > 0) %>%
    mutate(Model_Index = Model_Index*100) %>%
    select(-Model, -Value, -latitude,-longitude) %>%
    rename(index = INDEX) %>% 
    # joint eez names
    left_join(Index_Code,
              by = "index") %>% 
    # joint fao area names
    left_join(fao_areas,
              by = "index") %>% 
    mutate(
      territory = ifelse(!is.na(name),name,name_en),
      category = ifelse(!is.na(name),"eez","fao"),
    ) %>% 
    select(1:3,territory,category) %>% 
    clean_names() %>% 
    filter(model_index == 100)
  
  
  # Distributional test
  # test <- Trans_Spp %>% 
    # left_join(coords)
  
  # ggplot(test) +
  #   geom_tile(
  #     aes(
  #       x = lon,
  #       y = lat,
  #       fill = category
  #     )
  #   )

  
  
  # Step 2.1. Determines not a straddling stock
  if("fao" %in% Trans_Spp$category == FALSE){
    
    # output <- Spp_Grid %>% 
    #   select(
    #     taxon_key,
    #     territory,
    #     neighbour
    #   ) %>% 
    #   mutate(straddling = "no")
    return(print("not a straddling stock"))
    stop()
    
    
  }else{
    
    
    # MODEL INDEX (TRESHOLDS 1 & 2) #
    Model_Index_D <- Trans_Spp %>% 
      group_by(territory,
               category,
               taxon_key,
               model_index
      ) %>% 
      summarise(n_cells_spp = n()) %>% 
      select(-n_cells_spp)
    
    
    #____________ ESTIMATING DISTRIBUTION INDEX (TRESHOLD 3)_________ #
    # The number of species' cells present within each country's EEZ
    
    # if(n_Territory > 1){
    
    #Step 1.  Get EEZ id and Neighbour
    Neighbours_List <- neighbours %>%
      group_by(territory,neighbour) %>%
      summarise(n=n()) %>%
      ungroup() %>%
      select(-n) %>% 
      left_join(fao_to_sau) %>% 
      filter(!is.na(territory))
    
    # Set FAO neighbours... 
    fao_neighbours <- Neighbours_List %>% 
      select(territory,fao_area_name) %>% 
      rename(territory = fao_area_name,
             neighbour = territory) %>% 
      group_by(territory, neighbour) %>% 
      summarise(n())
    
    
    fao_territory <- fao_neighbours %>% 
      rename(territory = neighbour,
             neighbour = territory)
    
    
    neighbours_list_fao <- fao_neighbours %>% 
      bind_rows(Neighbours_List,fao_territory) %>% 
      select(-fao_area_name)
    
    
    
    # Step 2. Determines the amount of grids present in each country
    Spp_Grid <- Trans_Spp %>% 
      group_by(taxon_key,
               model_index, # Un-comment after producing models x datasets
               territory,
               category) %>% 
      summarise(n_spp_eez = length(unique(index))) %>% 
      left_join(neighbours_list_fao,
                by = "territory") %>% 
      filter(territory %in% Trans_Spp$territory, #Filter out unwanted Neighbours (those who don't have grids within but get included because they are Neighbours)
             neighbour %in% Trans_Spp$territory)
    
    
    # Split dataframes to merge latter
    Territory_T <- Spp_Grid %>% 
      filter(category == "eez") %>% 
      ungroup() %>% 
      select(
        model_index, # Un-comment after producing models x datasets
        taxon_key,
        Name=territory,
        n_spp_eez
      )
    
    Neighbour_T <- Spp_Grid %>%
      filter(category == "eez") %>% 
      ungroup() %>% 
      select(
        model_index,
        taxon_key,
        n_spp_eez,
        territory,
        Name=neighbour,
        territory
      ) 
    
    
    fao_grid <- Spp_Grid %>% 
      filter(category == "fao") %>% 
      left_join(neighbours_list_fao) %>% 
      select(Name =neighbour,
             fao_name = territory,
             n_spp_eez.z = n_spp_eez)
    
    # Merge dataframes to get totals per Neighbourds
    Area_Index_D <- full_join(Territory_T,
                              Neighbour_T, 
                              by = c("model_index","Name","taxon_key")
    ) %>%
      left_join(fao_grid) %>% 
      filter(!is.na(fao_name)) %>% # remove non-straddling stocks
      rowwise() %>%
      mutate(spp_total = sum(n_spp_eez.x,n_spp_eez.y,n_spp_eez.z,na.rm=T)) %>% # Total gridcelles per Neighbours
      distinct() %>% # Removes false duplicates from `full_join()`
      rename(territory = Name,
             neighbour = territory,
             n_spp_country = n_spp_eez.x,
             n_spp_neighbour = n_spp_eez.y,
             n_spp_fao_area = n_spp_eez.z) %>%
      # Estimate if it is straddling
      mutate(stradling_index = (n_spp_fao_area/spp_total)*100)
    
    ### Save spp dataframe
    
    output <- Area_Index_D %>% 
      select(taxon_key,
             territory,
             neighbour,
             fao_name,
             stradling_index)
    
    File_Name <- paste(Spp,"_straddling.csv",sep = "")
    Save_Path <- my_path("R","Straddling", File_Name)
    
    # Save_Path <- paste(Results_Path,"Trans_Results/",File_Name,sep="")
    
    write_csv(output,
              Save_Path)
  }
} # closes function

 #Test me  
# suppressMessages(
#   StraddIndex(600069, Model = "All", Coord = coords, Index_Code = Index_Code)
# )

```

```{r Mclapply_Hack_Fun, eval= F , echo = T, warning = F, message = F}

# The hack

Mclapply_Hack <- function(...){
  ## Create a cluster
  size.of.list <- length(list(...)[[1]])
  
  cl <- makeCluster(min(size.of.list, n_cores))
  
  ## Find out the names of the loaded packages 
  loaded.package.names <- c(
    ## Base packages
    sessionInfo()$basePkgs,
    ## Additional packages
    names(sessionInfo()$otherPkgs))
  tryCatch( {
    
    ## Copy over all of the objects within scope to
    ## all clusters. 
    this.env <- environment()
    while( identical( this.env, globalenv() ) == FALSE ) {
      clusterExport(cl,
                    ls(all.names=TRUE, env=this.env),
                    envir=this.env)
      this.env <- parent.env(environment())
    }
    clusterExport(cl,
                  ls(all.names=TRUE, env=globalenv()),
                  envir=globalenv())
    
    ## Load the libraries on all the clusters
    ## N.B. length(cl) returns the number of clusters
    parLapply( cl, 1:length(cl), function(xx){
      lapply(loaded.package.names, function(yy) {
        require(yy , character.only=TRUE)})
    })
    
    ## Run the lapply in parallel 
    return( parLapply( cl, ...) )
  }, finally = {        
    ## Stop the cluster
    stopCluster(cl)
  })
  
  
  ## Warn the user if they are using Windows
  if( Sys.info()[['sysname']] == 'Windows' ){
    message(paste(
      "\n", 
      "   *** Microsoft Windows detected ***\n",
      "   \n",
      "   For technical reasons, the MS Windows version of mclapply()\n",
      "   is implemented as a serial function instead of a parallel\n",
      "   function.",
      "   \n\n",
      "   As a quick hack, we replace this serial version of mclapply()\n",
      "   with a wrapper to parLapply() for this R session. Please see\n\n",
      "     http://www.stat.cmu.edu/~nmv/2014/07/14/implementing-mclapply-on-windows \n\n",
      "   for details.\n\n"))
  }
  
  ## If the OS is Windows, set mclapply to the
  ## the hackish version. Otherwise, leave the
  ## definition alone. 
  mclapply <- switch( Sys.info()[['sysname']],
                      Windows = {Mclapply_Hack}, 
                      Linux   = {mclapply},
                      Darwin  = {mclapply})
  
}
## end mclapply.hack.R

```

### Control pannel

```{r control_pannel, eva = F}
# DBEM coordinate system
# complete_lat_lon <- my_path("Spa", "DBEM","complete_lon_lat_dbem.csv", read = T)

# Gabriel's coordinate system
CoorG <- my_path("G","FishForVisa/Data/Spatial/","coordinates_gab.csv",read =T) %>%
  mutate(INDEX = seq(1,259200,1))

# Fao combo
fao_to_sau <- my_path("Spa", extra_path = "SAU", name = "EEZ-FAO-Country-Combo.xlsx", read = T)

# Neighbouring dataset
neighbours <- my_path("Spa", extra_path = "SAU", name = "EEZ_Neighbour_List.xlsx", read = T, system = "jepa") %>%
  clean_names() %>% 
  rename(eez_id = eezid) %>% 
  left_join(fao_to_sau,
            by = "eez_id") %>%
  mutate(fao_area_name = ifelse(territory == "Korea (North)", "Pacific, Northwest",fao_area_name)) # Fix North Korea
  

# Dataset to match all SAU names
# matching_names <- my_path("G","Spatial/SAU", "sau_matching_names.csv", read = T)

# Load FishForVisa Results
transboundary_spp <- read_csv("https://media.githubusercontent.com/media/jepa/FishForVisa/master/Data/Results/Clean_Results_Trans.csv") %>% 
  # Set same filters as in FishForVisa
  filter(
    area_index >= 0.25,
    area_index <= 1-0.25,
    model_index >= 100
  )

# Double check we have 633 species
length(unique(transboundary_spp$taxon_key)) # 633


# Spp <- 600069 #x
# Model = "All" #x
coords <- my_path("Spa","DBEM","Lon_Lat_DBEM.txt",read = T, header = F)

# SAU relations between INDEX and Country's EEZs
# First get Vicky's data to get high seas
EEZIDs_List <- my_path("Spa","DBEM", "Updated_EEZList_17June2016.xlsx", read = T) %>% 
  rename(eez_id = eezid)
EEZ_CellID <- my_path("Spa","DBEM", "EEZ_CellID.xlsx", read = TRUE)
colnames(EEZ_CellID) <- c("eez_id","index")
sau_index_code <- EEZIDs_List %>%  #x
  left_join(EEZ_CellID)

```


```{r run_me, eval = F}
lapply(unique(transboundary_spp$taxon_key), StraddIndex, Model = "All", Coord = coords, Index_Code = Index_Code )

```


## Estimating Proportion change

### Functions

This function simply reads all results of straddling stocks (see previous step)

```{r Fun_GetTransResults, eval = T}

GetResults=function(Spp,type = "strad"){
  
  if(type == "strad"){
  # Set the path for each file
  Distpath <- paste(my_path("R","Straddling/"),Spp,"_straddling.csv",sep="")
  }else{
  Distpath <- paste(my_path("R","Per_change/"),Spp,"_perchg.csv",sep="")
  }
  
  # Loads all files in a df
  Load_Data <- bind_rows(lapply(Distpath, FUN=fread))
  
  if(nrow(Load_Data)>0){
  
  return(Load_Data)
  }
}


```

This function is the main analysis estimating the proportion change above historic levels

```{r estimate_proportion, eval = F}

taxon_proportion <- function(taxon_key){
  
  print(taxon_key)
  
  stradd_data <- GetResults(taxon_key) %>% 
    rename("fao_area_name"= "fao_name") %>% 
    left_join(high_mig_spp)
  
  
  category <- unique(stradd_data$cat)
  
  
  fao_areas <- stradd_data %>% 
    pull(fao_area_name) %>% 
    unique()
  
  files_path <- list.files("/Volumes/Enterprise/Data/dbem/dbem_cmip6/r_data",full.names = T)
  to_read <- paste0(taxon_key,"Abd.RData")
  
  for(m in 1:6){
    
    #################################
    # List esm folders
    file_to_read <- paste0(files_path[m],"/",to_read)
    if(file.exists(file_to_read)){
      load(file_to_read)
      
      # Transform it to df
      spp_data <- as.data.frame(sppabdfnl) %>% 
        rowid_to_column("index")
      colnames(spp_data) <- c("index",(seq(1951,2100,1)))
      rm(sppabdfnl) # remove original load
      
      for(i in 1:length(fao_areas)){
        # for(i in 1:3){
        
        fao_area <- fao_areas[i]
        
        # Get area of analysis 
        taxon_fao_dbem_area <- stradd_data %>% 
          filter(fao_area_name %in% fao_area) %>% 
          left_join(fao_area_grid,
                    by = "fao_area_name") %>% 
          select(index,fao_area_name,fao_area_code)
        
        spp_data_area <- spp_data %>% 
          filter(index %in% taxon_fao_dbem_area$index) %>% 
          gather("year","value",`1951`:`2100`) %>% 
          left_join(sau_index_code,
                    by = "index") %>% 
          left_join(meow_dbem_grid,
                    by = "index") %>% 
          mutate(name = ifelse(is.na(name),fao_area,"eezs"), # For adding high migratory
                 realm = ifelse(is.na(ecoregion),"high seas",realm) # for adding straddling
          ) %>% 
          # When straddling use realm when highly migratory just fao region
          {if(!is.na(category)) group_by(.,year,name) else group_by(., year,realm)} %>%
          summarise(total_zone_abd = sum(value,na.rm = T)) %>% 
          mutate(taxon_key = taxon_key) %>% 
          filter(total_zone_abd > 0) # fix bug for now
        
        # Estimate proportions
        
        total_yr_abd <- spp_data_area %>% 
          group_by(taxon_key,year) %>% 
          summarise(total_abd = sum(total_zone_abd))
        
        spp_proportion <- spp_data_area %>% 
          left_join(total_yr_abd,
                    by = c("year","taxon_key")) %>% 
          mutate(per = total_zone_abd/total_abd)
        
        # How it looks
        ggplot(spp_proportion) +
          geom_area(
            aes(
              x = as.numeric(year),
              y = per,
              # fill = name
              fill = realm
            )
          )
        
        
        
        # Estimate changes in abd proportion
        
        # Early proportions
        hs_historical_means <- spp_proportion %>% 
          filter(year <= 2014) %>%
          {if(!is.na(category)) group_by(.,taxon_key,name) else group_by(., taxon_key,realm)} %>%
          summarise(hs_mean = mean(per, na.rm = T),
                    hs_sd = sd(per, na.rm = T)) %>%
          mutate(top_tresh = hs_mean+2*hs_sd,
                 low_tresh = hs_mean-2*hs_sd) %>% 
          select(-hs_mean,-hs_sd)
        
        # Estimate future proportions that overshoot the mean =- 2 sd
        prop_chng <- spp_proportion %>% 
          mutate(period = ifelse(year >2020 & year <2040,"ear",
                                 ifelse(year > 2040 & year <2060,"mid",NA)
          )
          ) %>% 
          filter(!is.na(period)) %>% 
          {if(!is.na(category)) group_by(.,taxon_key,name,period) else group_by(., taxon_key,realm,period)} %>%
          summarise(mean = mean(per, na.rm = T)) %>% 
          left_join(hs_historical_means) %>% 
          mutate(change = ifelse(mean > top_tresh,"gain",
                                 ifelse(mean < low_tresh,"lost","same")
          )
          )
        
        
        if(i == 1){
          final_data <- prop_chng
        }else{
          
          if(nrow(prop_chng)==0){
            final_data <- final_data
          }else{
          final_data <- bind_rows(final_data,prop_chng)
          }
        }
        
      } # Closefao areas     
    }else{
      partial_data <- data.frame()
      final_data <- bind_rows(final_data,partial_data)
    }
    
    
    
    # Incorporate rcp and esm info to data
    final_data <- final_data %>% 
      mutate(esm = str_to_lower(str_sub(files_path[m],49,54)),
             rcp = paste0("rcp",str_sub(files_path[m],55,56))
      )
    
    if(m == 1){
      final_output <- final_data
    }else{
      final_output <- bind_rows(final_output,final_data)
    }
    
    
  } # Close models for loop
  
  
  # Save file
  name_file <- my_path("R","Per_change_realm", paste0(taxon_key,"_perchg.csv"))
  write_csv(final_output, name_file)
  return(paste("Data for",taxon_key, "saved"))
  
}

```

### Control pannel

```{r get_straddling, eval = F}

# Get fao areas on DBEM grid
fao_area_grid <- my_path("Spa", "DBEM","fao_to_dbem_grid.csv", read = T) 
meow_dbem_grid <- my_path("Spa","MEOW", "meow_dbem_grid.csv", read = T)
# SAU relations between INDEX and Country's EEZs
# First get Vicky's data to get high seas
EEZIDs_List <- my_path("Spa","DBEM", "Updated_EEZList_17June2016.xlsx", read = T) %>% 
  rename(eez_id = eezid)
EEZ_CellID <- my_path("Spa","DBEM", "EEZ_CellID.xlsx", read = TRUE)
colnames(EEZ_CellID) <- c("eez_id","index")
sau_index_code <- EEZIDs_List %>%  #x
  left_join(EEZ_CellID)

# Load stradling species
# One species for test
# stradd_data <- GetResults("600107") %>% 
  # rename("fao_area_name"= "fao_name")


# Spp list

spp_complete <- list.files(my_path("R","Straddling/"))

stradling_spp <- str_replace(spp_complete,"\\_.*","")

stradd_data <- bind_rows(
  lapply(stradling_spp,GetResults)
)


# List of SAU species
exploited_spp <- my_path("G","SAU", "exploited_species_list.csv", read = T)


# List of species identified as highly migratory based on UN 1995 agreement
high_mig_spp <- my_path("D","Species", "high_migratory_species.csv", read = T) %>% 
  left_join(exploited_spp)

```


### Proportion estimate

```{r proportion_call, eval = F}

# suppressMessages(
# taxon_proportion(taxon_key = 600107
#         )
# )


# suppressMessages(
#   lapply(stradling_spp,
#          taxon_proportion)
# )

# Parralelization


suppressMessages(
  mclapply(stradling_spp,
           taxon_proportion,
           mc.cores = detectCores()-2)
)





```

# Results

## Functions needed


## Data needed

```{r results_data, eva; = T}

#-----------------# 
## Georeferenced ##
#-----------------# 

# SAU relations between INDEX and Country's EEZs
EEZIDs_List <- my_path("Spa","DBEM", "Updated_EEZList_17June2016.xlsx", read = T) %>% 
  rename(eez_id = eezid)
EEZ_CellID <- my_path("Spa","DBEM", "EEZ_CellID.xlsx", read = TRUE)
colnames(EEZ_CellID) <- c("eez_id","index")
sau_index_code <- EEZIDs_List %>%  #x
  left_join(EEZ_CellID)

#world land 
sf_land <- ne_countries(scale = 'small', returnclass = c("sf")) %>% 
  st_transform(crs = 4326) 

# meows
sf_meow <- my_sf("MEOW") %>% 
  clean_names()
st_crs(sf_meow) = 4326

meow_dbem_grid <- my_path("Spa","MEOW", "meow_dbem_grid.csv", read = T) %>% 
  left_join(sau_index_code,
            by = "index")

# Get fao areas on DBEM grid
sf_fao <- my_sf("FAO") %>% 
  clean_names() %>% 
  filter(f_level == "MAJOR") %>% 
  select(1:7,fao_name = name_en)
st_crs(sf_fao) = 4326

fao_area_grid <- my_path("Spa", "DBEM","fao_to_dbem_grid.csv", read = T) 

#-----------------# 
## Spp related   ##
#-----------------# 

# List of SAU species
exploited_spp <- my_path("G","SAU", "exploited_species_list.csv", read = T)

# List of species identified as highly migratory based on UN 1995 agreement
high_mig_spp <- my_path("D","Species", "high_migratory_species.csv", read = T) %>% 
  left_join(exploited_spp)

## Straddling species ##
# Spp list
spp_complete <- list.files(my_path("R","Straddling/"))
stradling_spp <- str_replace(spp_complete,"\\_.*","")

# Get straddling stocks
shared_data <- bind_rows(
  lapply(stradling_spp,GetResults, type = "strad")
) %>% 
  left_join(high_mig_spp) %>% 
  mutate(category = ifelse(is.na(cat),"strad","high_mig"))


# Get proportion analysis

# Get straddling stocks
prop_data <- bind_rows(
  lapply(stradling_spp,GetResults, type = "prop")
) %>% 
  left_join(high_mig_spp) %>% 
  mutate(category = ifelse(is.na(cat),"strad","high_mig"),
         rcp = ifelse(rcp == "rcp6F","rcp26",
                      ifelse(rcp == "rcp5F","rcp85",rcp
                      )
         )
  )



```


## Straddling identification

### Straddling species map

```{r straddling_map, eval = T, echo = F}

# Scaling function for plot
scaling <- function(x,...){(x-min(x,...))/(max(x,...)-min(x,...))}

# Get MEOW and EEZs
meow_dbem_eez <- meow_dbem_grid %>% 
  group_by(ecoregion,territory = name) %>% 
  tally() %>% 
  select(-n)

# Number of straddling stocks by MEOW
strad_meow <- shared_data %>% 
  left_join(meow_dbem_eez) %>% 
  # View()
  group_by(ecoregion) %>% 
  summarise(n = length(unique(taxon_key))) %>% 
  mutate(scale_n = scaling(n))

# Number of straddling stocks by FAO region

fao_meow <- meow_dbem_grid %>% 
  left_join(fao_area_grid) %>% 
  group_by(ecoregion,fao_name = fao_area_name) %>% 
  filter(!is.na(fao_name)) %>% 
  tally() %>% 
  select(-n)

strad_fao <- shared_data %>%
    # filter(fao_name == "Indian Ocean, Eastern") %>% 
  left_join(meow_dbem_eez) %>% 
  group_by(fao_name,ecoregion) %>%
    # Estimate number of species per fao name and ecoregion (stock)
  summarise(n = length(unique(taxon_key))) %>% 
    # Add number of stocks per FAO region
  group_by(fao_name)  %>% 
    summarise(n = sum(n)) %>% 
  mutate(scale_n = scaling(n))

# Map it
ggplot() + 
  geom_sf(data = sf_fao %>%  left_join(strad_fao), aes(fill = scale_n)) +
  geom_sf(data = sf_meow %>% left_join(strad_meow), aes(fill = scale_n)) +
  geom_sf(data = sf_land, aes(), fill = "grey30", color = "grey30") +
  scale_fill_viridis_c("", na.value = "white") +
  my_ggtheme_m(leg_pos = "right") 

  # Save plot 
ggsave("./results/figures/straddling_species_scale.png",
       last_plot(),
       height = 7,
       width = 14
)

```




## Proportion change

### Proportion change map


```{r}


plot_data <- prop_data %>% 
  group_by(realm,esm,rcp,change) %>% 
  tally() %>% 
  group_by(realm,rcp,change) %>% 
  summarise(mean_n_shifts = mean(n,na.rm = T)) %>% 
  filter(!is.na(change))



# Get the name and the y position of each label
label_data <- plot_data %>% group_by(realm) %>% summarize(tot=sum(mean_n_shifts))%>% 
  rowid_to_column("id")
number_of_bar <- nrow(label_data)
angle <- 90 - 360 * (label_data$id-0.5) /number_of_bar     # I substract 0.5 because the letter must have the angle of the center of the bars. Not extreme right(1) or extreme left (0)
label_data$hjust <- ifelse( angle < -90, 1, 0)
label_data$angle <- ifelse(angle < -90, angle+180, angle)
 

  ggplot(plot_data) +
  geom_bar(
    aes(
      x = reorder(realm,mean_n_shifts),
      y = mean_n_shifts,
      fill = change,
      color = change
    ),
    stat = "identity"
  )  +
  facet_wrap(~rcp) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45,hjust = 1))
  # Custom the theme: no axis title and no cartesian grid
  # theme_minimal() +
  # theme(
    # axis.text = element_blank(),
    # axis.title = element_blank(),
    # panel.grid = element_blank(),
    # plot.margin = unit(rep(-1,4), "cm")      # Adjust the margin to make in sort labels are not truncated!
  )
  # This makes the coordinate polar instead of cartesian.
  # coord_polar(start = 0) +
  # Add the labels, using the label_data dataframe that we have created before
  # geom_text(data = label_data, aes(x = id,
  #                                y = tot+1,
  #                                label = ecoregion, 
  #                                hjust = hjust), 
  #           color="black", fontface="bold",alpha=0.6, size=2.5, angle= label_data$angle, inherit.aes = FALSE ) 
 
```























































